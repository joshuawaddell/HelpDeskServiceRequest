# Workflow name
name: deploy-workload

# Triggers
on: [workflow_dispatch]

# Variables
env:
    aci_prefix: ci-cop2940-test-eus-001
    aci_subnet_name: snet-cop2940-test-eus-containerInstance
    resource_group_name: rg-cop2940-test-eus-app
    runner_image: ghcr.io/colindembovsky/ubuntu-actions-runner:6d7a59dfa95ec094a5fa8292bad01158c374e3ad
    virtual_network_name: vnet-cop2940-test-eus-001

# Jobs
jobs:
  deploy_infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout Code
      uses: actions/checkout@v2
    
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy Bicep File
      uses: azure/arm-deploy@v1
      with:
        deploymentName: ${{ github.run_id }}
        resourceGroupName: ${{ env.resource_group_name }}
        template: ./infrastructure/main.bicep

  deploy_self_hosted_runner:
    needs: deploy_infrastructure
    name: Deploy Self-Hosted Runner   
    runs-on: ubuntu-latest
    steps:

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Runner
      run: |
        az container create \
          -g ${{ env.resource_group_name }} \
          -n ${{ env.aci_prefix }}-${{ github.run_id }} \
          --image ${{ env.runner_image }} \
          --restart-policy Never \
          --subnet /subscriptions/${{ secrets.AZURE_CREDENTIALS }}/resourceGroups/${{ env.resource_group_name }}/providers/Microsoft.Network/virtualNetworks/${{ env.virtual_network_name }}/subnets/${{ env.aci_subnet_name }} \
          --environment-variables \
            RUNNER_REPOSITORY_URL=https://github.com/${{ github.repository }} \
            GITHUB_TOKEN=${{ secrets.PAT }} \
            RUNNER_OPTIONS="--ephemeral" \
            RUNNER_NAME=${{ env.aci_prefix }}-${{ github.run_id }}

  delete_self_hosted_runner:
    needs: deploy_self_hosted_runner
    name: Delete Self-Hosted Runner
    runs-on: ubuntu-latest
    steps:

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Delete Runner
      run: |
        az container delete -g ${{ env.resource_group_name }} -n ${{ env.aci_prefix }}-${{ github.run_id }} --yes